<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #0696d7;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #0696d7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0576b7;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .endpoint {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 3px;
            font-family: monospace;
            display: inline-block;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Azure Integration Test Suite</h1>
        
        <div class="info-box">
            <h3>Test Instructions:</h3>
            <ol>
                <li>Click each test button to verify different aspects of the Azure integration</li>
                <li>Review the JSON responses to ensure everything is working correctly</li>
                <li>Check the browser console (F12) for additional debug information</li>
                <li>Make sure your application is running on the expected port</li>
            </ol>
        </div>

        <!-- Test 1: Check Configuration -->
        <div class="test-section">
            <h2>Test 1: Check Azure Configuration</h2>
            <p>Verifies that Azure Blob Storage is properly configured and accessible.</p>
            <button class="test-button" onclick="testAzureConfig()">Run Test</button>
            <div id="config-result"></div>
        </div>

        <!-- Test 2: List Blobs -->
        <div class="test-section">
            <h2>Test 2: List Azure Blobs</h2>
            <p>Lists all blobs in your Azure storage container.</p>
            <button class="test-button" onclick="testListBlobs()">List All Blobs</button>
            <button class="test-button" onclick="testListBlobs('svf/')">List SVF Blobs</button>
            <div id="blobs-result"></div>
        </div>

        <!-- Test 3: Generate SAS URL -->
        <div class="test-section">
            <h2>Test 3: Generate SAS URL</h2>
            <p>Generates a SAS URL for accessing a blob.</p>
            <input type="text" id="blob-name" placeholder="Enter blob name" value="test.txt" style="padding: 8px; margin-right: 10px;">
            <button class="test-button" onclick="testGenerateSAS()">Generate SAS</button>
            <div id="sas-result"></div>
        </div>

        <!-- Test 4: Model Derivative -->
        <div class="test-section">
            <h2>Test 4: Model Derivative API</h2>
            <p>Tests Forge/APS Model Derivative API integration.</p>
            <button class="test-button" onclick="testCreateBucket()">Create Test Bucket</button>
            <div id="bucket-result"></div>
        </div>

        <!-- Test 5: Full Workflow -->
        <div class="test-section">
            <h2>Test 5: Full Translation Workflow</h2>
            <p>Tests the complete workflow: Azure ‚Üí Forge ‚Üí Model Derivative.</p>
            <input type="text" id="azure-file" placeholder="Azure blob name" value="MRConfigurator.zip" style="padding: 8px; margin-right: 10px;">
            <button class="test-button" onclick="testFullWorkflow()">Run Full Workflow</button>
            <div id="workflow-result"></div>
        </div>

        <!-- Test 6: Check Translation -->
        <div class="test-section">
            <h2>Test 6: Check Translation Progress</h2>
            <p>Check the progress of a Model Derivative translation job.</p>
            <input type="text" id="urn-input" placeholder="Enter URN" style="padding: 8px; margin-right: 10px; width: 300px;">
            <button class="test-button" onclick="testCheckTranslation()">Check Progress</button>
            <div id="translation-result"></div>
        </div>

        <!-- Test 7: Azure Models List -->
        <div class="test-section">
            <h2>Test 7: Azure Models API</h2>
            <p>Tests the Azure models listing endpoint.</p>
            <button class="test-button" onclick="testAzureModels()">List Azure Models</button>
            <div id="models-result"></div>
        </div>

        <!-- Test 9: RF Joist SAS Test -->
        <div class="test-section">
            <h2>Test 9: RF Joist with SAS URL</h2>
            <p>Tests RF Joist.zip using SAS URL approach for better reliability.</p>
            <button class="test-button" onclick="testRFJoistSAS()">Test RF Joist SAS</button>
            <div id="rf-joist-result"></div>
        </div>

        <!-- Test 10: Get SAS URL -->
        <div class="test-section">
            <h2>Test 10: Get SAS URL for Any Blob</h2>
            <p>Generate a SAS URL for direct access to any blob.</p>
            <input type="text" id="sas-blob-name" placeholder="Blob name" value="RF Joist.zip" style="padding: 8px; margin-right: 10px;">
            <button class="test-button" onclick="testGetSasUrl()">Get SAS URL</button>
            <div id="get-sas-result"></div>
        </div>

        <!-- Test 8: List ZIP Contents -->
        <div class="test-section">
            <h2>Test 8: List ZIP Contents</h2>
            <p>Lists the contents of a ZIP file to find the root file.</p>
            <input type="text" id="zip-file" placeholder="ZIP file name" value="MRConfigurator.zip" style="padding: 8px; margin-right: 10px;">
            <button class="test-button" onclick="testListZipContents()">List Contents</button>
            <div id="zip-result"></div>
        </div>

        <!-- File Upload and Translate -->
        <div class="test-section" style="background-color: #e8f5e9;">
            <h2>üöÄ Upload File and Translate to SVF</h2>
            <p>Upload a CAD file (ZIP, IAM, IPT, etc.) and translate it to SVF format for viewing.</p>
            
            <div style="margin: 20px 0;">
                <input type="file" id="file-upload" accept=".zip,.iam,.ipt,.dwg,.rvt" style="margin-bottom: 10px;">
                <br>
                <input type="text" id="root-filename" placeholder="Root filename for ZIP (optional)" style="padding: 8px; width: 300px; margin-bottom: 10px;">
                <br>
                <button class="test-button" onclick="uploadAndTranslate()" style="background-color: #4CAF50;">Upload and Translate</button>
            </div>
            
            <div id="upload-progress" style="display: none; margin: 10px 0;">
                <div style="background-color: #ddd; height: 20px; border-radius: 10px;">
                    <div id="progress-bar" style="background-color: #4CAF50; height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
                </div>
                <p id="progress-text" style="margin-top: 5px;">Uploading...</p>
            </div>
            
            <div id="upload-result"></div>
        </div>

        <!-- Azure Only Upload -->
        <div class="test-section" style="background-color: #fff3cd;">
            <h2>‚òÅÔ∏è Upload to Azure Only (No Forge)</h2>
            <p>Upload files directly to Azure Blob Storage without Forge translation. Use this if Forge is timing out.</p>
            
            <div style="margin: 20px 0;">
                <input type="file" id="azure-only-file" accept=".zip,.iam,.ipt,.dwg,.rvt" style="margin-bottom: 10px;">
                <br>
                <button class="test-button" onclick="uploadToAzureOnly()" style="background-color: #ffc107;">Upload to Azure Only</button>
            </div>
            
            <div id="azure-only-result"></div>
        </div>

        <!-- Two-Step Translation -->
        <div class="test-section" style="background-color: #e3f2fd;">
            <h2>üîÑ Two-Step Translation Process</h2>
            <p><strong>Step 1:</strong> Upload to Azure using the yellow section above<br>
               <strong>Step 2:</strong> Paste the Azure URL here to translate to SVF</p>
            
            <div style="margin: 20px 0;">
                <input type="text" id="azure-url-input" placeholder="Paste Azure SAS URL here" style="padding: 8px; width: 100%; margin-bottom: 10px;">
                <input type="text" id="translate-filename" placeholder="Filename (optional)" style="padding: 8px; width: 300px; margin-bottom: 10px;">
                <input type="text" id="translate-root" placeholder="Root filename for ZIP (optional)" style="padding: 8px; width: 300px; margin-bottom: 10px;">
                <br>
                <button class="test-button" onclick="translateFromAzureUrl()" style="background-color: #2196F3;">Translate from Azure URL</button>
            </div>
            
            <div id="translate-azure-result"></div>
        </div>

        <!-- Forge Connection Test -->
        <div class="test-section" style="background-color: #ffebee;">
            <h2>üîå Test Forge Connection</h2>
            <p>Diagnose Forge connectivity issues by testing authentication and basic operations.</p>
            <button class="test-button" onclick="testForgeConnection()" style="background-color: #f44336;">Test Forge Connection</button>
            <div id="forge-connection-result"></div>
        </div>

        <!-- API Reference -->
        <div class="test-section">
            <h2>API Endpoints Reference</h2>
            <p>You can also test these endpoints directly using tools like Postman or curl:</p>
            <div class="endpoint">GET /api/test/azure/check-config</div><br>
            <div class="endpoint">GET /api/test/azure/list-blobs?prefix=svf</div><br>
            <div class="endpoint">POST /api/test/azure/create-test-bucket</div><br>
            <div class="endpoint">GET /api/test/azure/generate-sas?blobName=test.txt</div><br>
            <div class="endpoint">POST /api/test/azure/test-full-workflow?azureBlobName=file.zip</div><br>
            <div class="endpoint">GET /api/test/azure/check-translation?urn=YOUR_URN</div><br>
            <div class="endpoint">GET /api/azure-models</div><br>
            <div class="endpoint">POST /api/modelderivative/translate/azure/{blobName}</div>
        </div>
    </div>

    <script>
        // Helper function to display results
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = 'result ' + (isError ? 'error' : 'success');
            element.textContent = JSON.stringify(data, null, 2);
        }

        function displayLoading(elementId) {
            const element = document.getElementById(elementId);
            element.className = 'result loading';
            element.textContent = 'Loading...';
        }

        // Test 1: Check Azure Configuration
        async function testAzureConfig() {
            displayLoading('config-result');
            try {
                const response = await fetch('/api/test/azure/check-config');
                const data = await response.json();
                displayResult('config-result', data, data.status === 'error');
            } catch (error) {
                displayResult('config-result', { error: error.message }, true);
            }
        }

        // Test 2: List Blobs
        async function testListBlobs(prefix = '') {
            displayLoading('blobs-result');
            try {
                const url = prefix ? `/api/test/azure/list-blobs?prefix=${prefix}` : '/api/test/azure/list-blobs';
                const response = await fetch(url);
                const data = await response.json();
                displayResult('blobs-result', data, data.status === 'error');
            } catch (error) {
                displayResult('blobs-result', { error: error.message }, true);
            }
        }

        // Test 3: Generate SAS URL
        async function testGenerateSAS() {
            const blobName = document.getElementById('blob-name').value;
            if (!blobName) {
                displayResult('sas-result', { error: 'Please enter a blob name' }, true);
                return;
            }
            
            displayLoading('sas-result');
            try {
                const response = await fetch(`/api/test/azure/generate-sas?blobName=${encodeURIComponent(blobName)}`);
                const data = await response.json();
                displayResult('sas-result', data, data.status === 'error');
            } catch (error) {
                displayResult('sas-result', { error: error.message }, true);
            }
        }

        // Test 4: Create Bucket
        async function testCreateBucket() {
            displayLoading('bucket-result');
            try {
                const response = await fetch('/api/test/azure/create-test-bucket', { method: 'POST' });
                const data = await response.json();
                displayResult('bucket-result', data, data.status === 'error');
            } catch (error) {
                displayResult('bucket-result', { error: error.message }, true);
            }
        }

        // Test 5: Full Workflow
        async function testFullWorkflow() {
            const azureFile = document.getElementById('azure-file').value;
            if (!azureFile) {
                displayResult('workflow-result', { error: 'Please enter an Azure blob name' }, true);
                return;
            }
            
            displayLoading('workflow-result');
            try {
                const response = await fetch(`/api/test/azure/test-full-workflow?azureBlobName=${encodeURIComponent(azureFile)}`, { 
                    method: 'POST' 
                });
                const data = await response.json();
                displayResult('workflow-result', data, data.status === 'error');
                
                // If successful, populate the URN field for checking progress
                if (data.steps && data.steps.translationStarted) {
                    document.getElementById('urn-input').value = data.steps.translationStarted;
                }
            } catch (error) {
                displayResult('workflow-result', { error: error.message }, true);
            }
        }

        // Test 6: Check Translation
        async function testCheckTranslation() {
            const urn = document.getElementById('urn-input').value;
            if (!urn) {
                displayResult('translation-result', { error: 'Please enter a URN' }, true);
                return;
            }
            
            displayLoading('translation-result');
            try {
                const response = await fetch(`/api/test/azure/check-translation?urn=${encodeURIComponent(urn)}`);
                const data = await response.json();
                displayResult('translation-result', data, data.status === 'error');
            } catch (error) {
                displayResult('translation-result', { error: error.message }, true);
            }
        }

        // Test 7: Azure Models
        async function testAzureModels() {
            displayLoading('models-result');
            try {
                const response = await fetch('/api/azure-models');
                const data = await response.json();
                displayResult('models-result', data, response.status !== 200);
            } catch (error) {
                displayResult('models-result', { error: error.message }, true);
            }
        }

        // Test 9: RF Joist SAS Test
        async function testRFJoistSAS() {
            displayLoading('rf-joist-result');
            try {
                const response = await fetch('/api/test/azure/test-rf-joist-sas', { method: 'POST' });
                const data = await response.json();
                displayResult('rf-joist-result', data, data.status === 'error');
            } catch (error) {
                displayResult('rf-joist-result', { error: error.message }, true);
            }
        }

        // Test 10: Get SAS URL
        async function testGetSasUrl() {
            const blobName = document.getElementById('sas-blob-name').value;
            if (!blobName) {
                displayResult('get-sas-result', { error: 'Please enter a blob name' }, true);
                return;
            }
            
            displayLoading('get-sas-result');
            try {
                const response = await fetch(`/api/test/azure/get-sas-url/${encodeURIComponent(blobName)}`);
                const data = await response.json();
                displayResult('get-sas-result', data, response.status !== 200);
            } catch (error) {
                displayResult('get-sas-result', { error: error.message }, true);
            }
        }

        // Test 8: List ZIP Contents
        async function testListZipContents() {
            const zipFile = document.getElementById('zip-file').value;
            if (!zipFile) {
                displayResult('zip-result', { error: 'Please enter a ZIP file name' }, true);
                return;
            }
            
            displayLoading('zip-result');
            try {
                const response = await fetch(`/api/test/azure/list-zip-contents?azureBlobName=${encodeURIComponent(zipFile)}`);
                const data = await response.json();
                displayResult('zip-result', data, data.status === 'error');
            } catch (error) {
                displayResult('zip-result', { error: error.message }, true);
            }
        }

        // Upload and Translate
        async function uploadAndTranslate() {
            const fileInput = document.getElementById('file-upload');
            const rootFilename = document.getElementById('root-filename').value;
            
            if (!fileInput.files.length) {
                displayResult('upload-result', { error: 'Please select a file to upload' }, true);
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            if (rootFilename) {
                formData.append('rootFilename', rootFilename);
            }
            
            // Show progress
            document.getElementById('upload-progress').style.display = 'block';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Uploading...';
            
            try {
                // Upload with progress tracking
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        document.getElementById('progress-bar').style.width = percentComplete + '%';
                        document.getElementById('progress-text').textContent = `Uploading... ${Math.round(percentComplete)}%`;
                    }
                });
                
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        document.getElementById('upload-progress').style.display = 'none';
                        displayResult('upload-result', data, data.status === 'error' || data.status === 'partial');
                        
                        // If successful, offer to check translation progress
                        if (data.status === 'success' && data.translation && data.translation.urn) {
                            setTimeout(() => {
                                if (confirm('Translation started! Check progress now?')) {
                                    document.getElementById('urn-input').value = data.translation.urn;
                                    testCheckTranslation();
                                }
                            }, 1000);
                        }
                    } else {
                        throw new Error(`Upload failed: ${xhr.statusText}`);
                    }
                });
                
                xhr.addEventListener('error', function() {
                    throw new Error('Upload failed');
                });
                
                xhr.open('POST', '/api/test/azure/upload-and-translate');
                xhr.send(formData);
                
            } catch (error) {
                document.getElementById('upload-progress').style.display = 'none';
                displayResult('upload-result', { error: error.message }, true);
            }
        }

        // Upload to Azure Only
        async function uploadToAzureOnly() {
            const fileInput = document.getElementById('azure-only-file');
            
            if (!fileInput.files.length) {
                displayResult('azure-only-result', { error: 'Please select a file to upload' }, true);
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            displayLoading('azure-only-result');
            
            try {
                const response = await fetch('/api/test/azure/upload-to-azure-only', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                displayResult('azure-only-result', data, data.status === 'error');
                
                // If successful, show download link
                if (data.status === 'success' && data.sasUrl) {
                    const resultDiv = document.getElementById('azure-only-result');
                    resultDiv.innerHTML += `<br><a href="${data.sasUrl}" target="_blank" style="color: #007bff;">üì• Download from Azure</a>`;
                }
            } catch (error) {
                displayResult('azure-only-result', { error: error.message }, true);
            }
        }

        // Translate from Azure URL
        async function translateFromAzureUrl() {
            const azureUrl = document.getElementById('azure-url-input').value;
            const fileName = document.getElementById('translate-filename').value;
            const rootFilename = document.getElementById('translate-root').value;
            
            if (!azureUrl) {
                displayResult('translate-azure-result', { error: 'Please enter an Azure URL' }, true);
                return;
            }
            
            displayLoading('translate-azure-result');
            
            try {
                const response = await fetch('/api/test/azure/translate-from-azure-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        azureUrl: azureUrl,
                        fileName: fileName,
                        rootFilename: rootFilename
                    })
                });
                
                const data = await response.json();
                displayResult('translate-azure-result', data, data.status === 'error');
                
                // If successful, offer to check translation progress
                if (data.status === 'success' && data.urn) {
                    setTimeout(() => {
                        if (confirm('Translation started! Check progress now?')) {
                            document.getElementById('urn-input').value = data.urn;
                            testCheckTranslation();
                        }
                    }, 1000);
                }
            } catch (error) {
                displayResult('translate-azure-result', { error: error.message }, true);
            }
        }

        // Test Forge Connection
        async function testForgeConnection() {
            displayLoading('forge-connection-result');
            try {
                const response = await fetch('/api/test/azure/test-forge-connection');
                const data = await response.json();
                
                // Format the results nicely
                if (data.results) {
                    let formattedData = {
                        ...data,
                        results: data.results.map(r => ({
                            ...r,
                            '‚úì': r.status === 'success' ? '‚úÖ' : (r.status === 'failed' ? '‚ùå' : '‚è≥')
                        }))
                    };
                    displayResult('forge-connection-result', formattedData, data.status === 'error');
                } else {
                    displayResult('forge-connection-result', data, data.status === 'error');
                }
            } catch (error) {
                displayResult('forge-connection-result', { error: error.message }, true);
            }
        }

        // Run initial test on page load
        window.onload = () => {
            testAzureConfig();
        };
    </script>
</body>
</html>